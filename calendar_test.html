<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Calendar ‚Äî Tracker</title>
<style>
  *, *::before, *::after { box-sizing: border-box; }
  html, body { height:100%; margin:0; }
  :root {
    --accent:#111827; --line:#111827; --text:#111827;
    --bg:#ffffff; --panel:#ffffff; --button-glow:rgba(173,216,230,0.8);

    --month-title-size:18px;
    --day-header-size:12px;
    --day-value-size:12px;

    --title-font-size:20px; --th-font-size:14px; --td-font-size:14px; --icon-size:18px;
  }

  body {
    font-family:system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Helvetica Neue", Arial;
    background:var(--bg); color:var(--text);
    margin:0;
    padding:0 6% 40px; /* flush top, margin bottom */
  }

  /* Top bar */
  .topbar {
    display:flex; justify-content:space-between; align-items:center; gap:10px;
    padding:10px 0; border-bottom:3px solid var(--line);
    position:sticky; top:0; z-index:10; background:var(--panel);
  }
  .nav-left, .nav-right { display:flex; gap:8px; flex-wrap:wrap; }
  .nav-btn, .settings-btn, .btn, .icon-btn {
    padding:6px 10px; font-size:14px;
    border-radius:10px; border:3px solid var(--line);
    background:#fff; color:var(--text); cursor:pointer;
    transition:transform .12s ease, box-shadow .12s ease;
    box-shadow:0 0 12px var(--button-glow);
  }
  .icon-btn { width:calc(var(--icon-size)+6px); height:calc(var(--icon-size)+6px);
              display:inline-flex; align-items:center; justify-content:center; }

  h1.page-title { text-align:center; margin:24px 0; font-weight:800; font-size:24px; }

  /* Cards responsive */
  .cards { display:grid; grid-template-columns: repeat(2, minmax(260px, 1fr)); gap:14px; margin-bottom:18px; }
  @media (max-width:1000px){ .cards { grid-template-columns:1fr; } }
  .card { background:var(--panel); border:3px solid var(--line); border-radius:14px; padding:12px; }
  .card-header { display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:10px; }
  .card-title { font-size:var(--title-font-size); font-weight:700; }

  /* Inputs */
  .input, select, input[type="text"], input[type="date"], input[type="number"] {
    width:100%; padding:6px 8px; font-size:14px;
    border-radius:10px; border:3px solid var(--line); background:#fff; color:var(--text);
  }

  /* Add Event form responsive */
  .form-row { display:grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap:12px; }

  /* Year controls */
  .year-controls { display:flex; justify-content:center; align-items:center; gap:12px; margin-bottom:14px; }
  .year-display { font-weight:800; font-size:20px; }

  /* Calendar grid */
  .calendar-grid { display:grid; grid-template-columns: repeat(4, 1fr); gap:12px; }
  @media (max-width:1200px){ .calendar-grid{grid-template-columns:repeat(3,1fr);} }
  @media (max-width:900px){  .calendar-grid{grid-template-columns:repeat(2,1fr);} }
  @media (max-width:560px){  .calendar-grid{grid-template-columns:1fr;} }

  .month { border:3px solid var(--line); border-radius:12px; padding:10px; background:#fff; }
  .month-title { font-size:var(--month-title-size); font-weight:800; margin-bottom:6px; text-align:center; }
  .weekday-row { display:grid; grid-template-columns: repeat(7, 1fr); gap:6px; margin-bottom:6px; }
  .weekday { font-size:var(--day-header-size); font-weight:700; text-align:center; border-bottom:1px solid rgba(17,24,39,0.2); padding:4px 0; }
  .days { display:grid; grid-template-columns: repeat(7, 1fr); gap:6px; }
  .day { border:1px solid rgba(17,24,39,0.2); border-radius:8px; min-height:48px; display:flex; align-items:flex-start; justify-content:flex-end; padding:6px; font-size:var(--day-value-size); background:#fff; }
  .day.sat, .day.sun { background:#e3f3ff; }
  .day.in-holiday { background:#3C7D22; color:#fff; }
  .day.in-vacation { background:#FFC000; color:#111; }

  /* Summary with labels */
  .summary-row { display:grid; grid-template-columns: repeat(4, 1fr); gap:10px; }
  @media (max-width:1000px){
    .summary-row { grid-template-columns:1fr; }
    .summary-row > div { width:100%; }
  }
  .summary-row label { white-space:nowrap; }
  .summary-field {
    width:100%; min-width:120px;
    text-align:center; font-weight:800; color:#fff;
    border:3px solid; border-radius:10px; padding:10px;
  }
  #yearAllowance { background:#782170; border-color:#4a133f; color:#fff; }
  #yearAllowance::-webkit-inner-spin-button,
  #yearAllowance::-webkit-outer-spin-button { -webkit-appearance:none; margin:0; }
  #yearAllowance[type=number] { -moz-appearance:textfield; }
  #totalHolidays { background:#3C7D22; border-color:#1f3f11; }
  #totalVacation { background:#FFC000; border-color:#806000; }
  #remainingVacation { background:#782170; border-color:#4a133f; }

  /* Modals unified with Tracker */
  .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,.25); display:none; align-items:flex-start; justify-content:center; z-index:30; overflow:auto; padding:40px 20px; }
  .modal { background:#fff; border:3px solid var(--line); border-radius:14px; width:90%; max-width:900px; margin:0 auto; padding:16px; max-height:90vh; overflow:auto; }
  .modal h3 { margin:0 0 12px; font-size:18px; }
  .section { margin-bottom:12px; }
  .chip { border:2px solid #FFC000; border-radius:999px; padding:4px 8px; font-size:13px; background:#fff; display:inline-flex; gap:6px; }
  .nowrap-btn, .nowrap-chip { white-space:nowrap; }

  /* Events table */
  .events-table { width:100%; border-collapse:collapse; margin-top:12px; }
  .events-table th, .events-table td { border:1px solid rgba(17,24,39,0.2); padding:8px; text-align:center; }
  .events-table th { font-weight:700; }
</style>
</head>
<body>
  <!-- Top bar -->
  <div class="topbar">
    <div class="nav-left">
      <button class="nav-btn" onclick="window.location.href='tracker.html'">Tracker</button>
      <button class="nav-btn active">Calendar</button>
    </div>
    <div class="nav-right">
      <button class="settings-btn" id="openEvents">Events</button>
      <button class="settings-btn" id="openSettings">Settings</button>
    </div>
  </div>

  <h1 class="page-title">Calendar</h1>

  <!-- Year controls -->
  <div class="year-controls">
    <button class="btn" id="prevYearBtn">‚Üê Prev Year</button>
    <div class="year-display" id="yearDisplay"></div>
    <button class="btn" id="nextYearBtn">Next Year ‚Üí</button>
  </div>

  <!-- Cards -->
  <div class="cards">
    <!-- Add Event -->
    <div class="card">
      <div class="card-header"><div class="card-title">Add Event</div></div>
      <div class="form-row">
        <div><label>Type</label><select id="eventType" class="input"><option value="holiday">Holiday</option><option value="vacation">Vacation</option></select></div>
        <div><label>Start date</label><input id="eventStart" type="date" class="input" /></div>
        <div><label>End date</label><input id="eventEnd" type="date" class="input" /></div>
      </div>
      <div style="display:flex;justify-content:flex-end;margin-top:12px">
        <button class="btn" id="addEventBtn">Add Event</button>
      </div>
    </div>

    <!-- Summary -->
    <div class="card">
      <div class="card-header"><div class="card-title">Summary</div></div>
      <div class="summary-row">
        <div>
          <label>Yearly Vacation</label>
          <input id="yearAllowance" class="summary-field" type="number" />
        </div>
        <div>
          <label>Total Holidays</label>
          <input id="totalHolidays" class="summary-field" readonly />
        </div>
        <div>
          <label>Used Vacation</label>
          <input id="totalVacation" class="summary-field" readonly />
        </div>
        <div>
          <label>Remaining Vacation</label>
          <input id="remainingVacation" class="summary-field" readonly />
        </div>
      </div>
    </div>
  </div>

  <!-- Calendar grid -->
  <div class="calendar-grid" id="calendarGrid"></div>

  <!-- Settings modal -->
  <div class="modal-backdrop" id="settingsModal">
    <div class="modal">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h3>Settings</h3>
        <button class="icon-btn" id="closeSettings">‚úï</button>
      </div>

      <div class="section">
        <strong>File binding:</strong>
        <div class="form-row" style="margin-top:8px">
          <button class="btn" id="bindFileBtn">Load JSON file</button>
          <button class="btn" id="reloadFileBtn">Reload from file</button>
          <span class="chip">Status: <span id="fileStatus">not bound</span></span>
        </div>
        <p style="opacity:.8;margin-top:6px">
          Bind tracker.json once. If empty, the app initializes the schema. Autosave updates without wiping existing content.
        </p>
      </div>

      <div class="section">
        <strong>Navigation:</strong>
        <div class="form-row" style="margin-top:8px">
          <input id="newNavLabel" class="input" placeholder="Button label (e.g., Reports)" />
          <input id="newNavUrl" class="input" placeholder="URL (e.g., https://example.com/reports)" />
        </div>
        <div style="display:flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:nowrap;">
          <button class="btn nowrap-btn" id="addNavBtn">Add Nav Button</button>
          <span class="chip nowrap-chip">Right-click a nav button to edit or delete</span>
        </div>
      </div>

      <div class="section">
        <strong>UI sizes:</strong>
        <div class="form-row" style="margin-top:8px">
          <div>
            <label>Card title size</label>
            <input id="fsTitle" class="input" type="number" min="12" max="36" step="1" value="20" />
          </div>
          <div>
            <label>Table header size</label>
            <input id="fsTh" class="input" type="number" min="10" max="24" step="1" value="14" />
          </div>
          <div>
            <label>Table cell size</label>
            <input id="fsTd" class="input" type="number" min="10" max="24" step="1" value="14" />
          </div>
          <div>
            <label>Icon size</label>
            <input id="fsIcon" class="input" type="number" min="12" max="32" step="1" value="18" />
          </div>
        </div>
        <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px">
          <button class="btn" id="applyUiSizes">Apply</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Events modal -->
  <div class="modal-backdrop" id="eventsModal">
    <div class="modal">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h3>Events</h3>
        <button class="icon-btn" id="closeEvents">‚úï</button>
      </div>
      <div class="form-row">
        <div>
          <label>Month</label>
          <select id="eventsMonthFilter" class="input"></select>
        </div>
        <div>
          <label>Type</label>
          <select id="eventsTypeFilter" class="input">
            <option value="all">All</option>
            <option value="holiday">Holiday</option>
            <option value="vacation">Vacation</option>
          </select>
        </div>
      </div>
      <table class="events-table">
        <thead>
          <tr><th>Type</th><th>Start</th><th>End</th><th>Actions</th></tr>
        </thead>
        <tbody id="eventsList"></tbody>
      </table>
    </div>
  </div>

  <!-- Edit event modal -->
  <div class="modal-backdrop" id="editModal">
    <div class="modal">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h3>Edit event</h3>
        <button class="icon-btn" id="closeEditModal">‚úï</button>
      </div>
      <div class="form-row">
        <div>
          <label>Type</label>
          <select id="editType" class="input">
            <option value="holiday">Holiday</option>
            <option value="vacation">Vacation</option>
          </select>
        </div>
        <div>
          <label>Start date</label>
          <input id="editStart" type="date" class="input" />
        </div>
        <div>
          <label>End date</label>
          <input id="editEnd" type="date" class="input" />
        </div>
      </div>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
        <button class="btn" id="saveEditBtn">Save</button>
      </div>
    </div>
  </div>

<script>
/* ===== Shared persistence (safe merge into tracker.json) ===== */
const DB_NAME = 'tracker-db';
const DB_STORE = 'file-handles';

function idbOpen() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, 1);
    req.onupgradeneeded = () => {
      const db = req.result;
      if (!db.objectStoreNames.contains(DB_STORE)) db.createObjectStore(DB_STORE);
    };
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}
async function idbGet(key) {
  const db = await idbOpen();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(DB_STORE, 'readonly'); const store = tx.objectStore(DB_STORE);
    const req = store.get(key);
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}
async function idbSet(key, value) {
  const db = await idbOpen();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(DB_STORE, 'readwrite'); const store = tx.objectStore(DB_STORE);
    const req = store.put(value, key);
    req.onsuccess = () => resolve();
    req.onerror = () => reject(req.error);
  });
}

const defaultData = {
  version: 1,
  ui: { fontSizes: { title: 20, th: 14, td: 14, icon: 18 } },
  nav: [{ label: 'Home', url: '#', id: 'home' }],
  filter: { month: new Date().getMonth()+1, year: new Date().getFullYear() },
  entries: { income: [], expenses: [], personal: [] }, // Tracker
  events: [],                                          // Calendar
  vacationAllowance: {},                               // Calendar
  meta: { notes: '' }
};

function ensureCoreStructures(obj) {
  obj.ui ||= defaultData.ui;
  obj.nav ||= [{label:'Home',url:'#',id:'home'}];
  obj.filter ||= { month: new Date().getMonth()+1, year: new Date().getFullYear() };
  obj.entries ||= { income: [], expenses: [], personal: [] };
  obj.events ||= [];
  obj.vacationAllowance ||= {};
  obj.meta ||= { notes: '' };
  return obj;
}
function deepMerge(target, source) {
  Object.keys(source || {}).forEach(key => {
    const sv = source[key];
    if (sv && typeof sv === 'object' && !Array.isArray(sv)) {
      target[key] ||= {};
      deepMerge(target[key], sv);
    } else {
      target[key] = sv;
    }
  });
}
async function writeFile(fileHandle, obj) {
  const writable = await fileHandle.createWritable();
  await writable.write(JSON.stringify(obj, null, 2));
  await writable.close();
}
async function reloadFromFile(fileHandle, dataRef) {
  const file = await fileHandle.getFile();
  const text = await file.text();
  let parsed; try { parsed = JSON.parse(text || '{}'); } catch { parsed = {}; }
  if (!parsed || Object.keys(parsed).length === 0) {
    parsed = structuredClone(defaultData);
    await writeFile(fileHandle, parsed);
  }
  const merged = ensureCoreStructures(structuredClone(defaultData));
  deepMerge(merged, parsed);
  Object.assign(dataRef, merged);
}
async function saveToFile(fileHandle, dataRef, renderFn=null) {
  if (!fileHandle) return;
  try {
    const file = await fileHandle.getFile();
    const currentText = await file.text().catch(()=> '{}');
    let current = {};
    try { current = JSON.parse(currentText || '{}'); } catch { current = {}; }
    current = ensureCoreStructures(current);

    const merged = structuredClone(current);
    deepMerge(merged, dataRef);

    await writeFile(fileHandle, merged);
    if (typeof renderFn === 'function') renderFn();
  } catch (e) { console.error('Autosave failed', e); }
}

/* ===== Page state & utilities ===== */
const today = new Date();
const monthNamesLong = ['January','February','March','April','May','June','July','August','September','October','November','December'];
const weekdayNames = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];

let data = structuredClone(defaultData);
let fileHandle = null;
let autosaveEnabled = false;
let currentYear = today.getFullYear();
let editContext = null;

function dateStr(y,m,d){ return `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`; }
function parseYMD(s){ const [y,m,d]=s.split('-').map(Number); return new Date(y,m-1,d); }
function getDaysInMonth(y, mIndex){ return new Date(y, mIndex+1, 0).getDate(); }
function dayOfWeekMonStart(y, mIndex, d){ const js=new Date(y, mIndex, d).getDay(); return (js+6)%7; } // 0=Mon..6=Sun
function isWeekend(y, mIndex, d){ const dow = dayOfWeekMonStart(y, mIndex, d); return dow >= 5; }

/* ===== Year controls ===== */
function setYear(y){
  currentYear = y;
  document.getElementById('yearDisplay').textContent = currentYear;
  renderCalendar(); renderSummary(); renderEventsTable();
}
document.getElementById('prevYearBtn').addEventListener('click', () => setYear(currentYear-1));
document.getElementById('nextYearBtn').addEventListener('click', () => setYear(currentYear+1));

/* ===== Add event form ===== */
const eventStartInput = document.getElementById('eventStart');
const eventEndInput = document.getElementById('eventEnd');
eventStartInput.addEventListener('change', () => { eventEndInput.value = eventStartInput.value; });
document.getElementById('addEventBtn').addEventListener('click', () => {
  const type = document.getElementById('eventType').value;
  const start = document.getElementById('eventStart').value;
  const end = document.getElementById('eventEnd').value;
  if (!type || !start || !end) { alert('Please provide Type, Start and End dates'); return; }
  if (new Date(end) < new Date(start)) { alert('End date cannot be before Start date'); return; }
  data.events.push({ id: crypto.randomUUID(), type, start, end });
  saveToFile(fileHandle, data, renderAll);
});

/* ===== Summary allowance auto-save ===== */
document.getElementById('yearAllowance').addEventListener('input', () => {
  const val = Number(document.getElementById('yearAllowance').value);
  if (!isNaN(val)) {
    data.vacationAllowance[currentYear] = val;
    saveToFile(fileHandle, data, renderAll);
  }
});

/* ===== Settings modal ===== */
function updateAutosaveState(){
  const fs = document.getElementById('fileStatus'); if (fs) fs.textContent = autosaveEnabled ? 'bound' : 'not bound';
}
document.getElementById('openSettings').addEventListener('click', () => {
  document.getElementById('settingsModal').style.display = 'flex';
  document.body.style.overflow = 'hidden';
});
document.getElementById('closeSettings').addEventListener('click', () => {
  document.getElementById('settingsModal').style.display = 'none';
  document.body.style.overflow = '';
});
document.getElementById('bindFileBtn')?.addEventListener('click', async () => {
  try {
    const [fh] = await window.showOpenFilePicker({
      types: [{ description: 'JSON', accept: { 'application/json': ['.json'] } }],
      multiple: false
    });
    fileHandle = fh;
    await idbSet('trackerFileHandle', fileHandle);
    autosaveEnabled = true;
    await reloadFromFile(fileHandle, data);
    updateAutosaveState();
    renderAll();
  } catch (e) {}
});
document.getElementById('reloadFileBtn')?.addEventListener('click', async () => {
  if (!fileHandle) { const stored = await idbGet('trackerFileHandle'); if (stored) fileHandle = stored; }
  if (!fileHandle) { alert('No file bound yet. Use "Load JSON file".'); return; }
  await reloadFromFile(fileHandle, data);
  renderAll();
});

/* ===== Settings UI sizes ===== */
function applyFontSizes(fs) {
  const r = document.documentElement;
  r.style.setProperty('--title-font-size', fs.title + 'px');
  r.style.setProperty('--th-font-size', fs.th + 'px');
  r.style.setProperty('--td-font-size', fs.td + 'px');
  r.style.setProperty('--icon-size', fs.icon + 'px');
}
function hydrateUI() {
  const fs = data.ui?.fontSizes || { title:20, th:14, td:14, icon:18 };
  document.getElementById('fsTitle').value = fs.title;
  document.getElementById('fsTh').value = fs.th;
  document.getElementById('fsTd').value = fs.td;
  document.getElementById('fsIcon').value = fs.icon;
  applyFontSizes(fs);
}
document.getElementById('applyUiSizes').addEventListener('click', () => {
  const fs = {
    title: Number(document.getElementById('fsTitle').value || 20),
    th: Number(document.getElementById('fsTh').value || 14),
    td: Number(document.getElementById('fsTd').value || 14),
    icon: Number(document.getElementById('fsIcon').value || 18)
  };
  data.ui.fontSizes = fs;
  applyFontSizes(fs);
  saveToFile(fileHandle, data, renderAll);
});

/* ===== Navigation in Settings ===== */
document.getElementById('addNavBtn')?.addEventListener('click', () => {
  const label = document.getElementById('newNavLabel').value.trim();
  const url = document.getElementById('newNavUrl').value.trim();
  if (!label) { alert('Provide a label'); return; }
  data.nav.push({ label, url: url || '#', id: crypto.randomUUID() });
  saveToFile(fileHandle, data, () => {});
  document.getElementById('newNavLabel').value = '';
  document.getElementById('newNavUrl').value = '';
});

/* ===== Events modal ===== */
document.getElementById('openEvents').addEventListener('click', () => {
  hydrateEventsFilters();
  renderEventsTable();
  document.getElementById('eventsModal').style.display = 'flex';
  document.body.style.overflow = 'hidden';
});
document.getElementById('closeEvents').addEventListener('click', () => {
  document.getElementById('eventsModal').style.display = 'none';
  document.body.style.overflow = '';
});
function hydrateEventsFilters() {
  const monthFilter = document.getElementById('eventsMonthFilter');
  monthFilter.innerHTML = '';
  const optAll = document.createElement('option'); optAll.value='all'; optAll.textContent='All';
  monthFilter.appendChild(optAll);
  monthNamesLong.forEach((mn, idx) => {
    const opt = document.createElement('option'); opt.value=String(idx+1); opt.textContent=mn;
    monthFilter.appendChild(opt);
  });
  monthFilter.value = 'all';
  document.getElementById('eventsTypeFilter').value = 'all';
}
document.getElementById('eventsMonthFilter').addEventListener('change', renderEventsTable);
document.getElementById('eventsTypeFilter').addEventListener('change', renderEventsTable);

function renderEventsTable() {
  const monthFilterVal = document.getElementById('eventsMonthFilter').value || 'all';
  const typeFilterVal = document.getElementById('eventsTypeFilter').value || 'all';
  let events = data.events.filter(e => {
    const s = parseYMD(e.start), en = parseYMD(e.end);
    return s.getFullYear() === currentYear || en.getFullYear() === currentYear;
  });
  if (typeFilterVal !== 'all') events = events.filter(e => e.type === typeFilterVal);
  if (monthFilterVal !== 'all') {
    const mNum = Number(monthFilterVal);
    events = events.filter(e => parseYMD(e.start).getMonth()+1 === mNum);
  }
  events.sort((a,b) => {
    const sa = parseYMD(a.start), sb = parseYMD(b.start);
    if (sa.getMonth() !== sb.getMonth()) return sa.getMonth() - sb.getMonth();
    return sa.getDate() - sb.getDate();
  });

  const tbody = document.getElementById('eventsList');
  tbody.innerHTML = '';
  events.forEach(e => {
    const tr = document.createElement('tr');
    const typeLabel = e.type === 'holiday' ? 'Holiday' : 'Vacation';
    tr.innerHTML = `
      <td>${typeLabel}</td>
      <td>${e.start}</td>
      <td>${e.end}</td>
      <td>
        <button class="icon-btn" title="Edit">‚úé</button>
        <button class="icon-btn" title="Delete">üóë</button>
      </td>`;
    tr.querySelector('button[title="Edit"]').addEventListener('click', () => openEditModal(e));
    tr.querySelector('button[title="Delete"]').addEventListener('click', () => {
      if (!confirm('Delete this event?')) return;
      data.events = data.events.filter(x => x.id !== e.id);
      saveToFile(fileHandle, data, renderAll);
    });
    tbody.appendChild(tr);
  });
}

/* ===== Edit event modal ===== */
function openEditModal(e) {
  editContext = { id: e.id };
  document.getElementById('editType').value = e.type;
  document.getElementById('editStart').value = e.start;
  document.getElementById('editEnd').value = e.end;
  document.getElementById('editModal').style.display = 'flex';
  document.body.style.overflow = 'hidden';
}
document.getElementById('closeEditModal').addEventListener('click', () => {
  editContext = null;
  document.getElementById('editModal').style.display = 'none';
  document.body.style.overflow = '';
});
document.getElementById('saveEditBtn').addEventListener('click', () => {
  if (!editContext) return;
  const type = document.getElementById('editType').value;
  const start = document.getElementById('editStart').value;
  const end = document.getElementById('editEnd').value;
  if (!type || !start || !end) { alert('Please provide Type, Start and End dates'); return; }
  if (new Date(end) < new Date(start)) { alert('End date cannot be before Start date'); return; }
  const idx = data.events.findIndex(ev => ev.id === editContext.id);
  if (idx === -1) return;
  data.events[idx] = { id: editContext.id, type, start, end };
  editContext = null;
  document.getElementById('editModal').style.display = 'none';
  document.body.style.overflow = '';
  saveToFile(fileHandle, data, renderAll);
});

/* ===== Calendar rendering (Mon start; vacation skips weekends & holidays) ===== */
function renderCalendar() {
  const grid = document.getElementById('calendarGrid');
  grid.innerHTML = '';

  const eventsThisYear = data.events.filter(e => {
    const s = parseYMD(e.start), en = parseYMD(e.end);
    return s.getFullYear() === currentYear || en.getFullYear() === currentYear;
  });

  const holidaySet = new Set();
  const vacationSet = new Set();

  // Holidays first
  eventsThisYear.filter(e=>e.type==='holiday').forEach(e=>{
    let cur = parseYMD(e.start), end = parseYMD(e.end);
    for (let d = new Date(cur); d <= end; d.setDate(d.getDate()+1)) {
      const key = dateStr(d.getFullYear(), d.getMonth()+1, d.getDate());
      holidaySet.add(key);
    }
  });

  // Vacations next; skip holidays and weekends automatically
  eventsThisYear.filter(e=>e.type==='vacation').forEach(e=>{
    let cur = parseYMD(e.start), end = parseYMD(e.end);
    for (let d = new Date(cur); d <= end; d.setDate(d.getDate()+1)) {
      const y = d.getFullYear(), mIdx = d.getMonth(), day = d.getDate();
      const key = dateStr(y, mIdx+1, day);
      if (holidaySet.has(key)) continue;      // skip holiday day
      if (isWeekend(y, mIdx, day)) continue;  // skip weekend automatically
      vacationSet.add(key);
    }
  });

  for (let mIdx=0; mIdx<12; mIdx++) {
    const monthEl = document.createElement('div'); monthEl.className = 'month';
    const title = document.createElement('div'); title.className = 'month-title'; title.textContent = `${monthNamesLong[mIdx]} ${currentYear}`;
    monthEl.appendChild(title);

    const weekdays = document.createElement('div'); weekdays.className = 'weekday-row';
    weekdayNames.forEach(w => {
      const el = document.createElement('div'); el.className = 'weekday'; el.textContent = w;
      weekdays.appendChild(el);
    });
    monthEl.appendChild(weekdays);

    const daysWrap = document.createElement('div'); daysWrap.className = 'days';
    const daysInMonth = getDaysInMonth(currentYear, mIdx);
    const firstDow = dayOfWeekMonStart(currentYear, mIdx, 1);

    // Leading blanks
    for (let i=0; i<firstDow; i++) {
      const empty = document.createElement('div'); empty.className = 'day'; empty.style.visibility='hidden';
      daysWrap.appendChild(empty);
    }
    // Days
    for (let d=1; d<=daysInMonth; d++) {
      const dayEl = document.createElement('div'); dayEl.className = 'day';
      const dow = dayOfWeekMonStart(currentYear, mIdx, d);
      if (dow === 5) dayEl.classList.add('sat');
      if (dow === 6) dayEl.classList.add('sun');

      const key = dateStr(currentYear, mIdx+1, d);
      const isHoliday = holidaySet.has(key);
      const isVacation = vacationSet.has(key);

      if (isHoliday) dayEl.classList.add('in-holiday');
      else if (isVacation) dayEl.classList.add('in-vacation');

      dayEl.textContent = d;
      daysWrap.appendChild(dayEl);
    }

    monthEl.appendChild(daysWrap);
    grid.appendChild(monthEl);
  }
}

/* ===== Summary calculations ===== */
function renderSummary() {
  const allowance = Number(data.vacationAllowance[currentYear] || 0);
  document.getElementById('yearAllowance').value = allowance;

  let holidayDays = 0;
  let vacationDays = 0;

  data.events.forEach(e => {
    const start = parseYMD(e.start), end = parseYMD(e.end);
    for (let cur = new Date(start); cur <= end; cur.setDate(cur.getDate()+1)) {
      if (cur.getFullYear() !== currentYear) continue;
      const y = cur.getFullYear(), mIdx = cur.getMonth(), d = cur.getDate();

      if (e.type === 'holiday') {
        holidayDays++;
      } else if (e.type === 'vacation') {
        if (isWeekend(y, mIdx, d)) continue; // exclude weekends automatically
        const isHolidayDay = data.events.some(h=>{
          if (h.type!=='holiday') return false;
          const hs = parseYMD(h.start), he = parseYMD(h.end);
          return hs <= cur && cur <= he;
        });
        if (isHolidayDay) continue; // vacation skips holidays
        vacationDays++;
      }
    }
  });

  document.getElementById('totalHolidays').value = holidayDays;
  document.getElementById('totalVacation').value = vacationDays;
  document.getElementById('remainingVacation').value = Math.max(0, allowance - vacationDays);
}

/* ===== Events table render/update ===== */
function renderEventsTable() {
  const monthFilterVal = document.getElementById('eventsMonthFilter').value || 'all';
  const typeFilterVal = document.getElementById('eventsTypeFilter').value || 'all';
  let events = data.events.filter(e => {
    const s = parseYMD(e.start), en = parseYMD(e.end);
    return s.getFullYear() === currentYear || en.getFullYear() === currentYear;
  });
  if (typeFilterVal !== 'all') events = events.filter(e => e.type === typeFilterVal);
  if (monthFilterVal !== 'all') {
    const mNum = Number(monthFilterVal);
    events = events.filter(e => parseYMD(e.start).getMonth()+1 === mNum);
  }
  events.sort((a,b) => {
    const sa = parseYMD(a.start), sb = parseYMD(b.start);
    if (sa.getMonth() !== sb.getMonth()) return sa.getMonth() - sb.getMonth();
    return sa.getDate() - sb.getDate();
  });

  const tbody = document.getElementById('eventsList');
  tbody.innerHTML = '';
  events.forEach(e => {
    const tr = document.createElement('tr');
    const typeLabel = e.type === 'holiday' ? 'Holiday' : 'Vacation';
    tr.innerHTML = `
      <td>${typeLabel}</td>
      <td>${e.start}</td>
      <td>${e.end}</td>
      <td>
        <button class="icon-btn" title="Edit">‚úé</button>
        <button class="icon-btn" title="Delete">üóë</button>
      </td>`;
    tr.querySelector('button[title="Edit"]').addEventListener('click', () => openEditModal(e));
    tr.querySelector('button[title="Delete"]').addEventListener('click', () => {
      if (!confirm('Delete this event?')) return;
      data.events = data.events.filter(x => x.id !== e.id);
      saveToFile(fileHandle, data, renderAll);
    });
    tbody.appendChild(tr);
  });
}

/* ===== Render all ===== */
function renderAll(){ setYear(currentYear); }

/* ===== Init ===== */
window.addEventListener('load', async () => {
  document.getElementById('yearDisplay').textContent = currentYear;
  const stored = await idbGet('trackerFileHandle');
  if (stored) { fileHandle = stored; autosaveEnabled = true; updateAutosaveState(); await reloadFromFile(fileHandle, data); }
  hydrateUI();
  renderAll();
});
</script>
</body>
</html>
